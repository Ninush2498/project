<!DOCTYPE html>
<html>
<body>

<title id="player">New game</title>

<button onclick="pravidla()">How to play</button>

<p id="paragraph"></p>

<script src="/socket.io/socket.io.js"></script>

<script src="public/bundle.js"></script>

<script src="public/Game.js"></script>

<script>

    var host;
    var port;

    function pravidla() {
        if (typeof host === "undefined") {
            setTimeout(pravidla, 100);
        }
        if (host == "localhost") {
            window.open(`http://${host + ":" + port}/pravidla`);
        } else {
            window.open(`${host}/pravidla`);
        }
    }

    const queryString = require('/node_modules/query-string/index.js');

    const urlParams = queryString.parse(window.location.search);

    //if (typeof urlParams.code === "undefined" && typeof sessionStorage.getItem("connected") === "undefined") {location.replace();}

    console.log(`The code is: ${urlParams.code}`);

    var socket = io();
    var player;


    socket.emit('createMessage', {
        code: "access",
        value: urlParams.code
    });
    
    
    var f = document.createElement("div");
    var b1 = document.createElement("button");
    b1.type = "button";
    b1.innerHTML = "New game";
    var b2 = document.createElement("button");
    b2.type = "button";
    b2.innerHTML = "Join in an existing game";
    f.appendChild(b1);
    f.appendChild(b2);
    b1.onclick = function() {
        Game.main(socket);
        document.getElementsByTagName("body")[0].removeChild(f);
    }
    b2.onclick = function() {
        if (typeof host === "undefined") {
            setTimeout(b2.onclick, 100);
        }
        sessionStorage.setItem("connected", "true");
        if (host == "localhost") {
            location.replace(`http://${host + ":" + port}/joinGame`);
        } else {
            location.replace(`${host}/joinGame`);
        }
    }
    document.getElementsByTagName("body")[0].appendChild(f);

    function printState(str) {
        var state = str.visible;
        var s = "{numOfPlayers: " + state.numOfPlayers + ", ";
        s += "numOfDices: " + state.numOfDices + ", ";
        s += "numOfVisibleDices: " + state.numOfVisibleDices + ", ";
        s += "guess: {count: " + state.guess.count + ", value: " + state.guess.value + "}, ";
        s += "players: [";
        for (var i=0; i<state.players.length-1; i++) {
            s += "{active: " + state.players[i].active;
            if (state.players[i].active) {
                s += "visibleDices: [";
                for (var j=0; j<state.players[i].visibleDices.length-1; j++) {
                    if (state.players[i].visibleDices[j]!=0) {
                        s += state.players[i].visibleDices[j] + " ";
                    }
                }
                if (state.players[i].visibleDices[state.players[i].visibleDices.length-1]!=0) {
                    s += state.players[i].visibleDices[j] + " ";
                }
                s += "]";
            }
            s += "}, ";
        }
        s += "{active: " + state.players[state.players.length-1].active;
        if (state.players[state.players.length-1].active) {
            s += ", visibleDices: [";
            for (var j=0; j<state.players[state.players.length-1].visibleDices.length-1; j++) {
                if (state.players[state.players.length-1].visibleDices[j]!=0) {
                    s += state.players[state.players.length-1].visibleDices[j] + " ";
                }
            }
            if (state.players[state.players.length-1].visibleDices[state.players[state.players.length-1].visibleDices.length-1]!=0) {
                s += state.players[state.players.length-1].visibleDices[state.players[state.players.length-1].visibleDices.length-1] + " ";
            }
            s += "]";
        }
        s += "}";
        s += "]";
        s += ", dices: [";
        for (var i=0; i<str.dices.length-1; i++) {
            s += str.dices[i] + " ";
        }
        s += str.dices[str.dices.length-1] + "]";
        s += "}";
        return s;
    }

    socket.on('connect', function(){
        console.log('Connected to Server');
    });

    socket.on('newMessage', function(message){
        console.log(message);
        switch(message.code) {
            case 0: //environment variables
                host = message.value.HOST;
                port = message.value.PORT;
                break;
            case 1: //status
                if (message.value.status=="OK") {
                    sessionStorage.setItem("gameID", message.value.gameID);
                    sessionStorage.setItem("playerID", message.value.index);
                    document.getElementById("player").innerHTML = "Player " + (message.value.index+1);
                    document.getElementById("paragraph").innerHTML = "";
                    player = message.value.player;
                } else {
                    document.getElementById("paragraph").innerHTML = "Sorry, you can't play.";
                }
                break;
            case 2: //print
                document.getElementById("paragraph").innerHTML += message.value + "<br/>";
                if (message.value=="Congratulations, you won!") {
                    alert("Game ends");
                }
                break;
            case 3: //ask boolean
                document.getElementById("paragraph").innerHTML += message.value.message + "<br/>";
                var b = new Boolean();
                Game.nextBoolean(b, socket, message.value.continue, message.value.num, sessionStorage.getItem("gameID"));
                break;
            case 4: //ask integer
                document.getElementById("paragraph").innerHTML += message.value.message + "<br/>";
                var n = new Number();
                var callback = Game.send;
                var f;
                var args;
                var smaller;
                var bigger;
                if (message.value.smaller=="neg") {
                    smaller = Number.NEGATIVE_INFINITY;
                } else if (message.value.smaller=="pos") {
                    smaller = Number.POSITIVE_INFINITY;
                } else {
                    smaller = message.value.smaller;
                }
                if (message.value.bigger=="neg") {
                    bigger = Number.NEGATIVE_INFINITY;
                } else if (message.value.bigger=="pos") {
                    bigger = Number.POSITIVE_INFINITY;
                } else {
                    bigger = message.value.bigger;
                }
                switch(message.value.continue) {
                    case "send":
                        f = "rollAtBeginning";
                        args = null;
                        break;
                    case "addIndex":
                        f = "addIndex";
                        args = message.value.args;
                        break;
                    case "show":
                        f = "show";
                        args = null;
                        break;
                    case "raise1":
                        f = "raise1";
                        args = null;
                        break;
                    case "raise2":
                        f = "raise2";
                        args = message.value.args;
                        break;
                }
                Game.nextInteger(n, bigger, smaller, message.value.alert, callback, { socket: socket, value: n, function: f, args: args, gameID: sessionStorage.getItem("gameID") });
                break;
            case 5: //update
                socket.emit('createMessage', {
                    code: "update",
                    value: { value: message.value, gameID: sessionStorage.getItem("gameID") }
                });
                break;
            case 6: //receive state
                document.getElementById("paragraph").innerHTML += printState(message.value) + "<br/>";
                break;
        }
    });


    socket.on('disconnect', function(){
        console.log('Disconnected from server');
        sessionStorage.clear();
    });
</script> 


</body>
</html>
